<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æŠ•èµ„çƒ­ç‚¹ | TrendRadar</title>
  <link rel="icon" href="./img/trend-icon.png" />
  <meta name="description" content="TrendRadar æŠ•èµ„çƒ­ç‚¹è‡ªåŠ¨è¿½è¸ªç³»ç»Ÿ" />

  <style>
    :root{
      --bg:#f5f7fa; --card:#fff; --text:#111827; --sub:#6b7280;
      --brand:#2563eb; --muted:#eef2f7; --border:#e5e7eb; --shadow:0 2px 12px rgba(0,0,0,.06);
      --header:#0f172a; --headerText:#fff;
      --chip:#f1f5f9; --chipHover:#e2e8f0; --chipText:#1f2937;
      --ok:#16a34a; --warn:#eab308; --danger:#ef4444;
    }
    .dark{
      --bg:#0b1018; --card:#0f1622; --text:#e5e7eb; --sub:#9aa4b2;
      --brand:#4f8cff; --muted:#0b121c; --border:#213044; --shadow:0 2px 16px rgba(0,0,0,.35);
      --header:#070b12; --headerText:#e5e7eb;
      --chip:#101827; --chipHover:#122036; --chipText:#cbd5e1;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:"Inter","PingFang SC","Microsoft Yahei",system-ui,-apple-system,sans-serif; background:var(--bg); color:var(--text)}

    /* é¡¶éƒ¨æ  */
    .header{
      background:var(--header); color:var(--headerText);
      position:sticky; top:0; z-index:10; padding:12px 20px;
      display:flex; align-items:center; justify-content:space-between; box-shadow:var(--shadow);
    }
    .logo-wrap{display:flex;align-items:center;gap:10px;font-weight:700}
    .logo{width:28px;height:28px}
    .actions{display:flex;align-items:center;gap:10px}
    .btn{
      border:1px solid var(--border); background:transparent; color:var(--headerText);
      padding:6px 10px; border-radius:8px; cursor:pointer; font-size:.9rem;
    }
    .btn:hover{background:rgba(255,255,255,.06)}
    .update-time{font-size:.9rem; color:var(--sub)}

    /* ä¸»ä½“å¸ƒå±€ */
    .container{
      max-width:1160px; margin:30px auto; padding:0 18px;
      display:grid; grid-template-columns:2fr 1fr; gap:22px;
    }
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:12px; padding:20px; box-shadow:var(--shadow);
    }
    h2{
      margin:0 0 16px; font-size:1.08rem; color:var(--brand);
      border-left:4px solid var(--brand); padding-left:10px;
      display:flex; align-items:center; gap:6px;
    }
    .hint{color:var(--sub); font-size:.92rem}
    .divider{height:1px;background:var(--border);margin:12px 0}

    /* è¶‹åŠ¿åˆ—è¡¨ */
    .trend-list{display:flex;flex-direction:column;gap:14px}
    .trend-item{padding-bottom:12px;border-bottom:1px solid var(--border)}
    .trend-item:last-child{border-bottom:none;padding-bottom:0}
    .trend-title{
      margin:0 0 6px; font-weight:600; line-height:1.45; font-size:1rem;
    }
    .trend-title a{color:inherit; text-decoration:none}
    .trend-title a:hover{color:var(--brand); text-decoration:underline}
    .meta{color:var(--sub); font-size:.9rem; display:flex; gap:10px; flex-wrap:wrap}
    .badge{
      display:inline-flex; align-items:center; gap:6px; font-size:.78rem;
      padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:var(--chip); color:var(--chipText);
    }

    /* å…³é”®è¯ Chips */
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{
      background:var(--chip); color:var(--chipText); padding:6px 12px; border-radius:999px;
      border:1px solid var(--border); cursor:pointer; transition:.15s; user-select:none; font-size:.9rem;
    }
    .chip:hover{background:var(--chipHover)}

    /* å›¾è¡¨å¡ç‰‡ */
    .chart-wrap{height:300px}
    .src-note{color:var(--sub); font-size:.9rem; margin-top:8px}

    /* é¡µè„š */
    .footer{ text-align:center; color:var(--sub); padding:24px 12px; font-size:.88rem }

    /* å“åº”å¼ */
    @media (max-width:860px){
      .container{grid-template-columns:1fr; gap:18px}
      .chart-wrap{height:240px}
    }
  </style>
</head>
<body>
  <!-- é¡¶éƒ¨ -->
  <header class="header">
    <div class="logo-wrap">
      <img class="logo" src="./img/trend-icon.png" alt="logo" />
      <div>æŠ•èµ„çƒ­ç‚¹ | TrendRadar</div>
    </div>
    <div class="actions">
      <div class="update-time" id="update-time">åŠ è½½ä¸­...</div>
      <button id="theme-toggle" class="btn" aria-label="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™ æš—é»‘</button>
    </div>
  </header>

  <!-- ä¸»ä½“ -->
  <main class="container">
    <!-- å·¦ï¼šè¶‹åŠ¿å†…å®¹ -->
    <section class="card">
      <h2>ğŸ“ˆ ä»Šæ—¥é‡ç‚¹è¶‹åŠ¿</h2>
      <div class="hint" id="trend-hint">ä¼˜å…ˆåŠ è½½ api/trends.jsonï¼Œè‹¥æ— åˆ™æ˜¾ç¤ºå ä½</div>
      <div class="divider"></div>
      <div id="trend-list" class="trend-list">
        <!-- JS æ¸²æŸ“ -->
      </div>
    </section>

    <!-- å³ä¸Šï¼šçƒ­æœå…³é”®è¯ -->
    <section class="card">
      <h2>ğŸ”¥ çƒ­æœå…³é”®è¯</h2>
      <div class="chips" id="chips">
        <span class="chip">äººå·¥æ™ºèƒ½</span>
        <span class="chip">å°ç§¯ç”µ</span>
        <span class="chip">ç¢³ä¸­å’Œ</span>
        <span class="chip">ChatGPT</span>
        <span class="chip">å…‰ä¼</span>
        <span class="chip">å‡ç¨</span>
        <span class="chip">æ±½è½¦èŠ¯ç‰‡</span>
      </div>
    </section>

    <!-- å³ä¸‹ï¼šçƒ­åº¦æ›²çº¿ -->
    <section class="card">
      <h2>ğŸ“Š çƒ­è¯çƒ­åº¦è¶‹åŠ¿</h2>
      <div class="chart-wrap"><canvas id="hotChart"></canvas></div>
      <div id="chart-note" class="src-note">æ•°æ®åŠ è½½ä¸­â€¦</div>
    </section>
  </main>

  <footer class="footer">
    Â© 2025 TrendRadar | æ•°æ®æ¥æºï¼šåå°”è¡—è§é—» Â· æ–°æµªè´¢ç» Â· ç™¾åº¦æŒ‡æ•°
  </footer>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <script>
    /* ========== æ›´æ–°æ—¶é—´ ========== */
    const upEl = document.getElementById("update-time");
    upEl.textContent = "æ›´æ–°äº " + new Date().toLocaleString("zh-CN", {hour12:false});

    /* ========== ä¸»é¢˜ï¼šè·Ÿéšç³»ç»Ÿ + æ‰‹åŠ¨åˆ‡æ¢ + æŒä¹…åŒ– ========== */
    const THEME_KEY = "tr-theme";
    const toggleBtn = document.getElementById("theme-toggle");
    function applyTheme(mode){
      if(mode==="dark"){ document.documentElement.classList.add("dark"); toggleBtn.textContent="â˜€ï¸ äº®è‰²"; }
      else{ document.documentElement.classList.remove("dark"); toggleBtn.textContent="ğŸŒ™ æš—é»‘"; }
    }
    (function initTheme(){
      const saved = localStorage.getItem(THEME_KEY);
      if(saved){ applyTheme(saved); }
      else{
        const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
        applyTheme(prefersDark ? "dark":"light");
      }
    })();
    toggleBtn.onclick = () => {
      const dark = document.documentElement.classList.contains("dark");
      const next = dark ? "light":"dark";
      applyTheme(next); localStorage.setItem(THEME_KEY,next);
      // ä¸»é¢˜åˆ‡æ¢åæ›´æ–°å›¾è¡¨è‰²
      if(window.__hotChart){ window.__hotChart.update(); }
    };

    /* ========== è¶‹åŠ¿åˆ—è¡¨ï¼šä¼˜å…ˆ api/trends.json ========== */
    async function loadTrends(){
      const hint = document.getElementById("trend-hint");
      const box = document.getElementById("trend-list");
      box.innerHTML = "";

      try{
        const r = await fetch("./api/trends.json", {cache: "no-store"});
        if(!r.ok) throw new Error("no trends.json");
        const data = await r.json();

        hint.textContent = `æŠ¥å‘Šç”Ÿæˆæ—¶é—´ï¼š${(data.generated_at||"æœªçŸ¥").replace("T"," ").replace("+"," GMT+")} Â· å…±å¤„ç† ${data.total_titles_processed||"-"} æ¡`;
        // å–ç¬¬ä¸€ä¸ªå…³é”®è¯ç»„çš„æ ‡é¢˜ä½œä¸ºå±•ç¤ºï¼›ä¹Ÿå¯æ‹¼æ¥å¤šä¸ªåˆ†ç»„
        const groups = Array.isArray(data.trends)? data.trends : [];
        const items = groups.length ? groups[0].titles || [] : [];

        if(items.length === 0){
          hint.textContent += " Â· æœªè·å–åˆ°æ ‡é¢˜ï¼Œæ˜¾ç¤ºå ä½";
          renderPlaceholders(box);
          return;
        }

        items.slice(0, 12).forEach((t, idx) => {
          const el = document.createElement("div");
          el.className = "trend-item";
          el.innerHTML = `
            <div class="trend-title">
              <a href="${t.url||'#'}" target="_blank" rel="noopener">${escapeHtml(t.title||"æœªå‘½å")}</a>
            </div>
            <div class="meta">
              <span class="badge">æ¥æºï¼š${escapeHtml(t.source||"æœªçŸ¥")}</span>
              ${t.time_info ? `<span class="badge">æ—¶æ®µï¼š${escapeHtml(t.time_info)}</span>` : ""}
              ${Array.isArray(t.ranks) ? `<span class="badge">æ¦œä½ï¼š${t.ranks.join(",")}</span>` : ""}
              ${typeof t.appearance_count==="number" ? `<span class="badge">å‡ºç°ï¼š${t.appearance_count}æ¬¡</span>`:""}
            </div>
          `;
          box.appendChild(el);
        });
      }catch(e){
        hint.textContent = "æœªæ£€æµ‹åˆ° api/trends.json Â· æ˜¾ç¤ºå ä½æ•°æ®";
        renderPlaceholders(box);
      }
    }

    function renderPlaceholders(container){
      const mock = new Array(6).fill(0).map((_,i)=>({
        title:`æœªå‘½å ${i+1}`, url:"#", source:"æœªçŸ¥æ¥æº"
      }));
      mock.forEach(m=>{
        const el = document.createElement("div");
        el.className = "trend-item";
        el.innerHTML = `
          <div class="trend-title"><a href="#">${escapeHtml(m.title)}</a></div>
          <div class="meta"><span class="badge">æ¥æºï¼š${m.source}</span></div>
        `;
        container.appendChild(el);
      });
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    /* ========== çƒ­åº¦æ›²çº¿ï¼šä¼˜å…ˆæœ€æ–° output/<day>/metrics.json ========== */
    async function loadMetrics(){
      const note = document.getElementById("chart-note");
      let metrics = null, sourceUrl = "";

      try{
        // å°è¯•è¯»å–ç›®å½•ç´¢å¼•ï¼ˆä½ çš„ Pages é»˜è®¤å…è®¸ï¼‰ï¼Œæ‰¾æœ€æ–°æ—¥æœŸæ–‡ä»¶å¤¹
        const dir = await fetch("./output/", {cache:"no-store"}).then(r=>r.text());
        const ms = [...dir.matchAll(/href="(\d{8,})\/"/g)];
        if(ms.length){
          const latest = ms[ms.length-1][1];
          const url = `./output/${latest}/metrics.json`;
          const r = await fetch(url, {cache:"no-store"});
          if(r.ok){ metrics = await r.json(); sourceUrl = url; }
        }
      }catch(e){ /* ignore */ }

      if(!metrics){
        metrics = {
          labels:["09:30","10:00","10:30","11:00","13:00","14:00","14:30","15:00"],
          series:[
            {name:"äººå·¥æ™ºèƒ½", data:[12,18,25,27,30,28,35,40]},
            {name:"å…‰ä¼", data:[8,12,14,18,20,22,21,24]},
            {name:"å°ç§¯ç”µ", data:[10,11,13,15,16,18,19,22]}
          ]
        };
        note.textContent = "æ•°æ®æºï¼šç¤ºä¾‹ï¼ˆæœªæ£€æµ‹åˆ° metrics.jsonï¼‰";
      }else{
        note.textContent = "æ•°æ®æºï¼š" + sourceUrl;
      }

      renderChart(metrics);
    }

    function palette(n){
      const light = ["#4f8cff","#22c55e","#f59e0b","#ef4444","#a78bfa","#14b8a6","#e879f9","#06b6d4"];
      const dark  = ["#7ab0ff","#37d688","#ffb84d","#ff6b6b","#c4b5fd","#2dd4bf","#f472d0","#67e8f9"];
      const use = document.documentElement.classList.contains("dark") ? dark : light;
      return Array.from({length:n}, (_,i)=>use[i%use.length]);
    }

    function renderChart(d){
      const ctx = document.getElementById("hotChart");
      const colors = palette(d.series.length);
      const datasets = d.series.map((s,i)=>({
        label:s.name, data:s.data,
        borderColor:colors[i], backgroundColor:"transparent",
        tension:.25, borderWidth:2, pointRadius:2
      }));
      if(window.__hotChart) window.__hotChart.destroy();
      window.__hotChart = new Chart(ctx,{
        type:"line",
        data:{ labels:d.labels, datasets },
        options:{
          responsive:true, maintainAspectRatio:false,
          scales:{
            x:{ grid:{display:false}, ticks:{ color:getCss('--sub') } },
            y:{ grid:{ color:getCss('--border') }, ticks:{ color:getCss('--sub') } }
          },
          plugins:{
            legend:{ labels:{ color:getCss('--text') } },
            tooltip:{ mode:"index", intersect:false }
          }
        }
      });
    }
    function getCss(v){ return getComputedStyle(document.documentElement).getPropertyValue(v); }

    /* Init */
    loadTrends();
    loadMetrics();
  </script>
</body>
</html>
