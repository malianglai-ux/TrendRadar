<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>自建茧房 · 趋势洞察面板</title>
  <meta name="description" content="自建茧房：自动追踪全球信息脉络，聚合中英文趋势，按重合度计算热度，并标注来源。" />
  <link rel="icon" href="./img/trend-icon.png" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    :root{
      --bg:#f6f8fb; --card:#fff; --text:#0f172a; --muted:#64748b; --brand:#2563eb;
      --chip:#eef2ff; --chipText:#334155; --ok:#fb923c; --border:#e5e7eb; --shadow:0 8px 30px rgba(2,6,23,.06)
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:14px/1.6 system-ui,-apple-system,"PingFang SC","Microsoft YaHei",Segoe UI,Roboto,Ubuntu}
    a{color:inherit;text-decoration:none}
    .hero{
      height:320px; background:url('https://picx.zhimg.com/v2-53929aa63157aa2c5ff6fb2ecc22094b_r.jpg') center/cover no-repeat;
      position:relative; display:flex; align-items:flex-end; justify-content:center;
    }
    .hero::after{
      content:""; position:absolute; inset:0;
      background:linear-gradient(to bottom,rgba(15,23,42,.35) 0%,rgba(15,23,42,.25) 40%, rgba(246,248,251,1) 100%);
    }
    .hero-inner{
      position:relative; z-index:1; width:100%; max-width:1080px; padding:24px;
      color:#fff; transform:translateY(8px);
    }
    .title{font-weight:800; letter-spacing:.02em; font-size:28px}
    .subtitle{opacity:.95; margin-top:6px}

    .wrap{max-width:1080px;margin:-48px auto 40px;padding:0 20px;position:relative}
    .grid{display:grid;grid-template-columns:1.7fr .9fr;gap:18px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
    .card h3{margin:0;padding:14px 16px;border-bottom:1px solid var(--border);font-size:15px}
    .list{padding:8px}
    .item{display:flex;align-items:flex-start;gap:10px;padding:12px;border-radius:12px;border:1px solid transparent}
    .item + .item{margin-top:6px}
    .item:hover{background:#fafbff;border-color:#eef2ff}
    .rank{width:26px;height:26px;border-radius:8px;background:#eff6ff;color:#1d4ed8;display:grid;place-items:center;font-weight:700}
    .main{flex:1 1 auto;min-width:0}
    .t{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meta{margin-top:4px;color:var(--muted);font-size:12px;display:flex;gap:10px;align-items:center}
    .src{background:var(--chip);color:var(--chipText);padding:2px 8px;border-radius:999px;font-size:12px}
    .heat{margin-left:auto;color:#c2410c;background:#fff7ed;border:1px solid #fed7aa;padding:2px 8px;border-radius:999px;font-weight:700}
    .badge{font-size:12px;color:#334155;background:#e2e8f0;border-radius:999px;padding:2px 8px}
    .aside{padding:10px}
    .tag{display:inline-block;margin:6px 6px 0 0;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px}
    .footer{margin:24px 0;color:var(--muted);text-align:center;font-size:12px}
  </style>
</head>
<body>
  <!-- 顶部背景 -->
  <section class="hero">
    <div class="hero-inner">
      <div class="title">自建茧房 · 趋势洞察面板</div>
      <div class="subtitle">沉淀思考 · 守护专注 · 自动追踪全球信息脉络</div>
    </div>
  </section>

  <main class="wrap">
    <div class="grid">
      <!-- 左：趋势列表（按热度） -->
      <section class="card">
        <h3>📈 最新趋势（按热度）</h3>
        <div id="list" class="list"></div>
      </section>

      <!-- 右：关键词与统计 -->
      <aside class="card">
        <h3>🔥 热搜关键词</h3>
        <div id="tags" class="aside"></div>
        <div class="aside" style="border-top:1px solid var(--border);margin-top:8px;padding-top:12px">
          <span class="badge" id="meta-count">—</span>
          <span class="badge" id="meta-gen">—</span>
        </div>
      </aside>
    </div>
    <div class="footer">© 2025 自建茧房 · 数据来自多源聚合 · 按跨源重合度计算热度并标注来源</div>
  </main>

  <script>
    const API = './api/trends.json?v=' + Date.now(); // 强制绕过缓存

    // 分语言聚合：返回 { zh:[], en:[] }
    function splitLang(topics){
      const zh=[], en=[];
      for(const t of topics){
        const any = t.links && t.links[0]?.title || t.title || '';
        /[\u4e00-\u9fa5]/.test(any) ? zh.push(t) : en.push(t);
      }
      return { zh, en };
    }

    function renderList(container, items){
      container.innerHTML = '';
      items.forEach((t, idx)=>{
        const first = t.links?.[0] || {};
        const url = first.url || '#';
        const source = first.source || (t.sources?.[0] || '—');
        const title = first.title || t.title || '(无标题)';
        const heat = (t.heat ?? 0).toFixed ? t.heat.toFixed(0) : t.heat;

        const el = document.createElement('a');
        el.className='item';
        el.href = url;
        el.target = '_blank';
        el.rel='noopener noreferrer';
        el.innerHTML = `
          <div class="rank">${idx+1}</div>
          <div class="main">
            <div class="t">${title}</div>
            <div class="meta">
              <span class="src">来源：${source}</span>
            </div>
          </div>
          <div class="heat">热度：${heat ?? 0}</div>
        `;
        container.appendChild(el);
      });
    }

    function renderTags(container, items){
      container.innerHTML='';
      // 取标题关键词粗略切词
      const words = {};
      items.forEach(t=>{
        const title = (t.links?.[0]?.title || t.title || '').toLowerCase();
        const arr = title.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]+/g,' ').split(/\s+/).filter(x=>x && x.length>=2);
        arr.forEach(w=>{ words[w]=(words[w]||0)+1; });
      });
      const top = Object.entries(words).sort((a,b)=>b[1]-a[1]).slice(0,20);
      top.forEach(([w,c])=>{
        const span = document.createElement('span');
        span.className='tag';
        span.textContent = `${w} · ${c}`;
        container.appendChild(span);
      });
    }

    fetch(API).then(r=>r.json()).then(data=>{
      const topics = (data?.topics || []).map(t=>{
        // 兼容字段：聚合器已写入 heat；若没有则回退 size
        t.heat = t.heat ?? Math.round((t.size || 1) * 10);
        return t;
      });
      const { zh, en } = splitLang(topics);

      // 优先显示“全部”按热度排序
      const all = [...topics].sort((a,b)=> (b.heat??0)-(a.heat??0));
      renderList(document.getElementById('list'), all);
      renderTags(document.getElementById('tags'), all);

      // 页脚统计
      document.getElementById('meta-count').textContent = `主题数：${data?.topic_count ?? topics.length}`;
      document.getElementById('meta-gen').textContent   = `生成：${data?.generated_at ?? '—'}`;
    }).catch(e=>{
      const box = document.getElementById('list');
      box.innerHTML = `<div style="padding:16px;color:#ef4444">加载失败：${e?.message||e}</div>`;
    });
  </script>
</body>
</html>
