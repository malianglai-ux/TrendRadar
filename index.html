<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æŠ•èµ„çƒ­ç‚¹ | TrendRadar</title>
  <link rel="icon" href="./img/trend-icon.png" />
  <meta name="description" content="TrendRadar æŠ•èµ„çƒ­ç‚¹è‡ªåŠ¨è¿½è¸ªç³»ç»Ÿ" />

  <style>
    :root{
      --bg: #f5f7fa; --card: #ffffff; --text: #1f2d3d; --subtext:#6b7280;
      --brand:#2563eb; --muted:#eef2f7; --shadow: 0 2px 12px rgba(0,0,0,.06);
      --header:#0f172a; --headerText:#fff; --chip:#f1f5f9; --chipHover:#e2e8f0;
      --chipText:#1f2937; --border:#e5e7eb;
    }
    .dark{
      --bg:#0b1018; --card:#0f1622; --text:#e5e7eb; --subtext:#9aa4b2;
      --brand:#4f8cff; --muted:#0b121c; --shadow: 0 2px 14px rgba(0,0,0,.35);
      --header:#070b12; --headerText:#e5e7eb; --chip:#101827; --chipHover:#122036;
      --chipText:#cbd5e1; --border:#213044;
    }
    *{box-sizing:border-box}
    body{font-family:"Inter","PingFang SC","Microsoft Yahei",sans-serif;margin:0;background:var(--bg);color:var(--text)}
    .header{background:var(--header);color:var(--headerText);padding:12px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10;box-shadow:var(--shadow)}
    .header-left{display:flex;align-items:center;gap:10px;font-weight:700}
    .logo{width:28px;height:28px}
    .update-time{font-size:.9rem;color:var(--subtext)}
    .actions{display:flex;align-items:center;gap:10px}
    .btn{border:1px solid var(--border);background:transparent;color:var(--headerText);padding:6px 10px;border-radius:8px;cursor:pointer;font-size:.9rem}
    .btn:hover{background:rgba(255,255,255,.06)}
    .btn:active{transform:translateY(1px)}
    .container{max-width:1100px;margin:32px auto;padding:0 18px;display:grid;grid-template-columns:2fr 1fr;gap:22px}
    .card{background:var(--card);border-radius:12px;box-shadow:var(--shadow);padding:22px;border:1px solid var(--border)}
    h2{margin:0 0 16px;font-size:1.1rem;color:var(--brand);border-left:4px solid var(--brand);padding-left:10px}
    .trend-card{padding:12px 0;border-bottom:1px solid var(--border)}
    .trend-card:last-child{border-bottom:none}
    .trend-card h3{margin:0 0 6px;font-size:1rem}
    .source{color:var(--subtext);font-size:.92rem}
    .keywords{display:flex;flex-wrap:wrap;gap:8px}
    .keywords span{background:var(--chip);color:var(--chipText);padding:6px 12px;border-radius:999px;border:1px solid var(--border);cursor:pointer;transition:.15s;user-select:none;font-size:.9rem}
    .keywords span:hover{background:var(--chipHover)}
    .chart-wrap{height:280px}
    .footer{text-align:center;color:var(--subtext);padding:24px 10px;font-size:.88rem}
    @media (max-width:860px){.container{grid-template-columns:1fr;gap:18px}.chart-wrap{height:240px}}
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <img src="./img/trend-icon.png" class="logo" alt="logo"/>
      <div>æŠ•èµ„çƒ­ç‚¹ | TrendRadar</div>
    </div>
    <div class="actions">
      <div class="update-time" id="update-time">åŠ è½½ä¸­...</div>
      <button class="btn" id="theme-toggle" aria-label="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™ æš—é»‘</button>
    </div>
  </header>

  <main class="container">
    <section class="card" id="trend-content">
      <h2>ğŸ“ˆ ä»Šæ—¥é‡ç‚¹è¶‹åŠ¿</h2>
      <div class="trend-card"><h3>æ•°æ®åŠ è½½ä¸­...</h3><div class="source">è¯·ç¨å€™</div></div>
    </section>

    <section class="card">
      <h2>ğŸ”¥ çƒ­æœå…³é”®è¯</h2>
      <div class="keywords" id="kw">
        <span>äººå·¥æ™ºèƒ½</span><span>å°ç§¯ç”µ</span><span>ç¢³ä¸­å’Œ</span>
        <span>ChatGPT</span><span>å…‰ä¼</span><span>å‡ç¨</span><span>æ±½è½¦èŠ¯ç‰‡</span>
      </div>
    </section>

    <section class="card">
      <h2>ğŸ“Š çƒ­è¯çƒ­åº¦è¶‹åŠ¿</h2>
      <div class="chart-wrap"><canvas id="hotChart"></canvas></div>
      <div class="source" id="chart-note">æ•°æ®åŠ è½½ä¸­â€¦</div>
    </section>
  </main>

  <footer class="footer">
    Â© 2025 TrendRadar | æ•°æ®æ¥æºï¼šåå°”è¡—è§é—» Â· æ–°æµªè´¢ç» Â· ç™¾åº¦æŒ‡æ•°
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <script>
    /* ===== æ›´æ–°æ—¶é—´ ===== */
    const upEl = document.getElementById("update-time");
    upEl.textContent = "æ›´æ–°äº " + new Date().toLocaleString("zh-CN", {hour12:false});

    /* ===== ä¸»é¢˜åˆ‡æ¢ ===== */
    const key = "tr-theme";
    const toggleBtn = document.getElementById("theme-toggle");
    const applyTheme = (t) => {
      if(t==="dark"){ document.documentElement.classList.add("dark"); toggleBtn.textContent="â˜€ï¸ äº®è‰²"; }
      else { document.documentElement.classList.remove("dark"); toggleBtn.textContent="ğŸŒ™ æš—é»‘"; }
    };
    (()=>{ const saved = localStorage.getItem(key);
      if(saved){ applyTheme(saved); }
      else{ applyTheme(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"); }
    })();
    toggleBtn.onclick = () => { const next = document.documentElement.classList.contains("dark")?"light":"dark"; applyTheme(next); localStorage.setItem(key,next); };

    /* ===== é¢œè‰²å·¥å…· ===== */
    function cssVar(n){ return getComputedStyle(document.documentElement).getPropertyValue(n); }
    function getColors(n){
      const light = ["#4f8cff","#22c55e","#f59e0b","#ef4444","#a78bfa","#14b8a6","#e879f9"];
      const dark  = ["#7ab0ff","#37d688","#ffb84d","#ff6b6b","#c4b5fd","#2dd4bf","#f472d0"];
      const use = document.documentElement.classList.contains("dark") ? dark : light;
      return Array.from({length:n},(_,i)=>use[i%use.length]);
    }

    /* ===== æ¸²æŸ“ï¼šè¶‹åŠ¿åˆ—è¡¨ ===== */
    function renderTrends(list){
      const box = document.getElementById("trend-content");
      let html = `<h2>ğŸ“ˆ ä»Šæ—¥é‡ç‚¹è¶‹åŠ¿</h2>`;
      if(!list?.length){ html += `<div class="trend-card"><h3>æš‚æ— æ•°æ®</h3><div class="source">ç­‰å¾…ä¸‹ä¸€æ¬¡æŠ“å–</div></div>`; box.innerHTML = html; return; }
      list.slice(0,20).forEach(item=>{
        const title = item.title || item.name || "æœªå‘½å";
        const url   = item.url   || item.link || "#";
        const src   = item.source|| item.platform || "æœªçŸ¥æ¥æº";
        const time  = item.time  || item.ts || item.datetime || "";
        html += `
          <div class="trend-card">
            <h3><a href="${url}" target="_blank" rel="noopener noreferrer">${title}</a></h3>
            <div class="source">æ¥æºï¼š${src}${time ? " Â· " + time : ""}</div>
          </div>`;
      });
      box.innerHTML = html;
    }

    /* ===== æ¸²æŸ“ï¼šçƒ­æœå…³é”®è¯ chips ===== */
    function renderKeywords(arr){
      const el = document.getElementById("kw");
      if(!arr?.length) return;
      el.innerHTML = arr.slice(0,20).map(k=>{
        const text = (k.word || k.name || k[0] || k || "").toString();
        return `<span>${text}</span>`;
      }).join("");
    }

    /* ===== æ¸²æŸ“ï¼šçƒ­åº¦æ›²çº¿ ===== */
    let chart;
    function renderChart(dataset){
      const ctx = document.getElementById("hotChart");
      const colors = getColors(dataset.series.length);
      const ds = dataset.series.map((s,i)=>({
        label:s.name, data:s.data, borderColor:colors[i], backgroundColor:"transparent",
        tension:.25, borderWidth:2, pointRadius:2
      }));
      chart && chart.destroy();
      chart = new Chart(ctx,{
        type:"line",
        data:{ labels:dataset.labels, datasets:ds },
        options:{
          responsive:true, maintainAspectRatio:false,
          scales:{
            x:{ grid:{display:false}, ticks:{ color:cssVar('--subtext') } },
            y:{ grid:{ color:cssVar('--border') }, ticks:{ color:cssVar('--subtext') } }
          },
          plugins:{ legend:{ labels:{ color:cssVar('--text') } }, tooltip:{ mode:"index", intersect:false } }
        }
      });
    }

    const obs = new MutationObserver(()=>{ if(chart){ chart.update(); } });
    obs.observe(document.documentElement,{attributes:true, attributeFilter:["class"]});

    /* ===== ä» api/trends.json åŠ è½½æ•°æ® ===== */
    async function loadFromAPI(){
      const NOTE = document.getElementById("chart-note");
      try{
        const r = await fetch("./api/trends.json", {cache:"no-store"});
        if(!r.ok) throw new Error("no api");
        const j = await r.json();

        // æ›´æ–°æ—¶é—´
        const ts = j.updated_at || j.generated_at || j.time || "";
        if(ts) upEl.textContent = "æ›´æ–°äº " + ts;

        // è¶‹åŠ¿åˆ—è¡¨ï¼ˆå…¼å®¹å¤šç§å­—æ®µï¼‰
        const trendList = j.trends || j.items || j.data || j.top_trends || [];
        if(trendList.length) renderTrends(trendList);

        // å…³é”®è¯
        const kws = j.keywords || j.hot_keywords || j.tags || [];
        if(kws.length) renderKeywords(kws);

        // æ›²çº¿ï¼šä¼˜å…ˆä½¿ç”¨ j.metrics / j.chart / j.series
        let data;
        if(j.metrics?.labels && j.metrics?.series){ data = j.metrics; }
        else if(j.chart?.labels && j.chart?.series){ data = j.chart; }
        else if(j.series && j.labels){ data = {labels:j.labels, series:j.series}; }

        if(!data){
          // å›é€€ç¤ºä¾‹
          data = {
            labels:["09:30","10:00","10:30","11:00","13:00","14:00","14:30","15:00"],
            series:[
              {name:"äººå·¥æ™ºèƒ½", data:[12,18,25,27,30,28,35,40]},
              {name:"å…‰ä¼", data:[8,12,14,18,20,22,21,24]},
              {name:"å°ç§¯ç”µ", data:[10,11,13,15,16,18,19,22]}
            ]
          };
          NOTE.textContent = "æ•°æ®æºï¼šç¤ºä¾‹ï¼ˆtrends.json æœªæä¾›æ›²çº¿ï¼‰";
        }else{
          NOTE.textContent = "æ•°æ®æºï¼š/api/trends.json";
        }
        renderChart(data);
        return true;
      }catch(e){
        return false;
      }
    }

    /* ===== å›é€€ï¼šä» output ç›®å½•å°è¯•å¡«å……å·¦ä¾§å¡ç‰‡ + metrics.json å›¾è¡¨ ===== */
    async function loadFromOutput(){
      const NOTE = document.getElementById("chart-note");
      try{
        const resp = await fetch("./output/", {cache:"no-store"});
        const txt = await resp.text();
        const m = [...txt.matchAll(/href="(\d{8,})\/"/g)];
        if(!m.length) throw new Error("no-dir");
        const latest = m[m.length-1][1];

        // å·¦ä¾§æ—¥æŠ¥ HTML
        const report = `./output/${latest}/html/å½“æ—¥çƒ­ç‚¹.html`;
        const r = await fetch(report, {cache:"no-store"});
        if(r.ok){
          const html = await r.text();
          document.getElementById("trend-content").innerHTML = html;
        }

        // å›¾è¡¨ metrics.json
        let data;
        try{
          const rm = await fetch(`./output/${latest}/metrics.json`, {cache:"no-store"});
          if(rm.ok){ data = await rm.json(); NOTE.textContent = `æ•°æ®æºï¼š/output/${latest}/metrics.json`; }
        }catch(e){}

        if(!data){
          data = {
            labels:["09:30","10:00","10:30","11:00","13:00","14:00","14:30","15:00"],
            series:[
              {name:"äººå·¥æ™ºèƒ½", data:[12,18,25,27,30,28,35,40]},
              {name:"å…‰ä¼", data:[8,12,14,18,20,22,21,24]},
              {name:"å°ç§¯ç”µ", data:[10,11,13,15,16,18,19,22]}
            ]
          };
          NOTE.textContent = "æ•°æ®æºï¼šç¤ºä¾‹ï¼ˆæœªæ£€æµ‹åˆ° metrics.jsonï¼‰";
        }
        renderChart(data);
      }catch(e){
        // å½»åº•å›é€€ï¼šå·¦ä¾§ä¿æŒâ€œåŠ è½½ä¸­â€¦â€ï¼Œå›¾è¡¨ç”¨ç¤ºä¾‹
        const data = {
          labels:["09:30","10:00","10:30","11:00","13:00","14:00","14:30","15:00"],
          series:[
            {name:"äººå·¥æ™ºèƒ½", data:[12,18,25,27,30,28,35,40]},
            {name:"å…‰ä¼", data:[8,12,14,18,20,22,21,24]},
            {name:"å°ç§¯ç”µ", data:[10,11,13,15,16,18,19,22]}
          ]
        };
        NOTE.textContent = "æ•°æ®æºï¼šç¤ºä¾‹ï¼ˆæœªæ£€æµ‹åˆ° output ç›®å½•ï¼‰";
        renderChart(data);
      }
    }

    (async ()=>{
      const ok = await loadFromAPI();
      if(!ok) await loadFromOutput();
    })();
  </script>
</body>
</html>
