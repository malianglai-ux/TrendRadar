<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æŠ•èµ„çƒ­ç‚¹ | TrendRadar</title>
  <link rel="icon" href="./img/trend-icon.png" />
  <meta name="description" content="TrendRadar æŠ•èµ„çƒ­ç‚¹è‡ªåŠ¨è¿½è¸ªç³»ç»Ÿ" />

  <style>
    :root{
      --bg: #f5f7fa;
      --card: #ffffff;
      --text: #1f2d3d;
      --subtext:#6b7280;
      --brand:#2563eb;
      --muted:#eef2f7;
      --shadow: 0 2px 12px rgba(0,0,0,.06);
      --header:#0f172a; --headerText:#fff;
      --chip:#f1f5f9; --chipHover:#e2e8f0; --chipText:#1f2937;
      --border:#e5e7eb;
    }
    .dark{
      --bg:#0b1018;
      --card:#0f1622;
      --text:#e5e7eb;
      --subtext:#9aa4b2;
      --brand:#4f8cff;
      --muted:#0b121c;
      --shadow: 0 2px 14px rgba(0,0,0,.35);
      --header:#070b12; --headerText:#e5e7eb;
      --chip:#101827; --chipHover:#122036; --chipText:#cbd5e1;
      --border:#213044;
    }
    *{box-sizing:border-box}
    body{font-family:"Inter","PingFang SC","Microsoft Yahei",sans-serif;margin:0;background:var(--bg);color:var(--text);}
    .header{
      background:var(--header);color:var(--headerText);
      padding:12px 20px;display:flex;align-items:center;justify-content:space-between;
      position:sticky;top:0;z-index:10;box-shadow:var(--shadow);
    }
    .header-left{display:flex;align-items:center;gap:10px;font-weight:700;}
    .logo{width:28px;height:28px}
    .update-time{font-size:.9rem;color:var(--subtext)}
    .btn{border:1px solid var(--border);background:transparent;color:var(--headerText);
      padding:6px 10px;border-radius:8px;cursor:pointer;font-size:.9rem;}
    .btn:hover{background:rgba(255,255,255,.06)}
    .container{
      max-width:1100px;margin:32px auto;padding:0 18px;
      display:grid;grid-template-columns:2fr 1fr;gap:22px;
    }
    .card{
      background:var(--card);border-radius:12px;box-shadow:var(--shadow);padding:22px;
      border:1px solid var(--border);
    }
    h2{margin:0 0 16px;font-size:1.1rem;color:var(--brand);
      border-left:4px solid var(--brand);padding-left:10px;}
    .trend-card{padding:12px 0;border-bottom:1px solid var(--border)}
    .trend-card:last-child{border-bottom:none}
    .trend-card h3{margin:0 0 6px;font-size:1rem;}
    .trend-card a{text-decoration:none;color:var(--text);}
    .trend-card a:hover{text-decoration:underline;color:var(--brand);}
    .source{color:var(--subtext);font-size:.92rem}
    .keywords{display:flex;flex-wrap:wrap;gap:8px}
    .keywords span{background:var(--chip);color:var(--chipText);padding:6px 12px;
      border-radius:999px;border:1px solid var(--border);cursor:pointer;transition:.15s;
      user-select:none;font-size:.9rem;}
    .keywords span:hover{background:var(--chipHover)}
    .chart-wrap{height:280px}
    .footer{text-align:center;color:var(--subtext);padding:24px 10px;font-size:.88rem}
    @media(max-width:860px){.container{grid-template-columns:1fr;gap:18px}.chart-wrap{height:240px}}
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <img src="./img/trend-icon.png" class="logo" alt="logo"/>
      <div>æŠ•èµ„çƒ­ç‚¹ | TrendRadar</div>
    </div>
    <div class="actions">
      <div class="update-time" id="update-time">åŠ è½½ä¸­...</div>
      <button class="btn" id="theme-toggle" aria-label="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™ æš—é»‘</button>
    </div>
  </header>

  <main class="container">
    <section class="card" id="trend-content">
      <h2>ğŸ“ˆ ä»Šæ—¥é‡ç‚¹è¶‹åŠ¿</h2>
      <div class="trend-card"><h3>æ•°æ®åŠ è½½ä¸­...</h3><div class="source">è¯·ç¨å€™</div></div>
    </section>

    <section class="card">
      <h2>ğŸ”¥ çƒ­æœå…³é”®è¯</h2>
      <div class="keywords" id="kw">
        <span>äººå·¥æ™ºèƒ½</span><span>å°ç§¯ç”µ</span><span>ç¢³ä¸­å’Œ</span><span>ChatGPT</span><span>å…‰ä¼</span><span>å‡ç¨</span><span>æ±½è½¦èŠ¯ç‰‡</span>
      </div>
    </section>

    <section class="card">
      <h2>ğŸ“Š çƒ­è¯çƒ­åº¦è¶‹åŠ¿</h2>
      <div class="chart-wrap"><canvas id="hotChart"></canvas></div>
      <div class="source" id="chart-note">æ•°æ®åŠ è½½ä¸­â€¦</div>
    </section>
  </main>

  <footer class="footer">Â© 2025 TrendRadar | æ•°æ®æ¥æºï¼šåå°”è¡—è§é—» Â· æ–°æµªè´¢ç» Â· ç™¾åº¦æŒ‡æ•°</footer>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <script>
    const upEl=document.getElementById("update-time");
    upEl.textContent="æ›´æ–°äº "+new Date().toLocaleString("zh-CN",{hour12:false});

    const key="tr-theme",btn=document.getElementById("theme-toggle");
    const apply=t=>{
      if(t==="dark"){document.documentElement.classList.add("dark");btn.textContent="â˜€ï¸ äº®è‰²";}
      else{document.documentElement.classList.remove("dark");btn.textContent="ğŸŒ™ æš—é»‘";}
    };
    (()=>{const s=localStorage.getItem(key);
      if(s)apply(s);else{apply(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");}
    })();
    btn.onclick=()=>{const n=document.documentElement.classList.contains("dark");
      const next=n?"light":"dark";apply(next);localStorage.setItem(key,next);};

    /* è½½å…¥æ—¥æŠ¥ */
    async function loadLatestReport(){
      try{
        const r=await fetch("./output/");
        const t=await r.text();const m=[...t.matchAll(/href="(\d{8,})\/"/g)];
        if(!m.length)return;
        const latest=m[m.length-1][1];
        const f=`./output/${latest}/html/å½“æ—¥çƒ­ç‚¹.html`;
        const rf=await fetch(f);
        if(rf.ok){const h=await rf.text();document.getElementById("trend-content").innerHTML=h;}
      }catch(e){}
    }

    /* è½½å…¥ trends.json (ä½ çš„ç»“æ„é€‚é…) */
    async function loadTrendsAndKeywords(){
      try{
        const r=await fetch('./api/trends.json',{cache:'no-store'});
        if(!r.ok)throw new Error('no json');
        const j=await r.json();
        const groups=Array.isArray(j.trends)?j.trends:[];
        const items=groups.flatMap(g=>(g.titles||[]).map(t=>({
          title:t.title||t.name||'æœªå‘½å',
          url:t.url||t.link||'#',
          source:t.source||'æœªçŸ¥æ¥æº',
          time:t.time_info||'',
          keyword:g.keyword_group||''
        })));
        const box=document.getElementById('trend-content');
        const html=items.slice(0,10).map(x=>`
          <div class="trend-card">
            <h3><a href="${x.url}" target="_blank" rel="noopener">${x.title}</a></h3>
            <div class="source">æ¥æºï¼š${x.source}${x.keyword?` Â· ä¸»é¢˜ï¼š${x.keyword}`:''}${x.time?` Â· ${x.time}`:''}</div>
          </div>`).join('');
        box.innerHTML=`<h2>ğŸ“ˆ ä»Šæ—¥é‡ç‚¹è¶‹åŠ¿</h2>${html}`;
        const kws=[...new Set(groups.map(g=>g.keyword_group).filter(Boolean))];
        if(kws.length)document.getElementById('kw').innerHTML=kws.slice(0,12).map(k=>`<span>${k}</span>`).join('');
        const up=j.generated_at||j.updated_at;
        if(up)upEl.textContent=`æ›´æ–°äº ${up.replace('T',' ').replace('+08:00','')}`;
      }catch(e){console.warn(e);}
    }

    /* çƒ­åº¦å›¾ */
    async function loadMetrics(){
      const note=document.getElementById("chart-note");let data;
      try{
        const r1=await fetch("./output/");
        const tx=await r1.text();const m=[...tx.matchAll(/href="(\d{8,})\/"/g)];
        if(m.length){
          const latest=m[m.length-1][1];
          const url=`./output/${latest}/metrics.json`;
          const r2=await fetch(url);
          if(r2.ok){data=await r2.json();note.textContent=`æ•°æ®æºï¼š${url}`;}
        }
      }catch(e){}
      if(!data){
        data={labels:["09:30","10:00","10:30","11:00","13:00","14:00","14:30","15:00"],
          series:[
            {name:"äººå·¥æ™ºèƒ½",data:[12,18,25,27,30,28,35,40]},
            {name:"å…‰ä¼",data:[8,12,14,18,20,22,21,24]},
            {name:"å°ç§¯ç”µ",data:[10,11,13,15,16,18,19,22]}
          ]};
        note.textContent="æ•°æ®æºï¼šç¤ºä¾‹ï¼ˆæœªæ£€æµ‹åˆ° metrics.jsonï¼‰";
      }
      renderChart(data);
    }

    function getColors(n){
      const light=["#4f8cff","#22c55e","#f59e0b","#ef4444","#a78bfa","#14b8a6","#e879f9"];
      const dark=["#7ab0ff","#37d688","#ffb84d","#ff6b6b","#c4b5fd","#2dd4bf","#f472d0"];
      const use=document.documentElement.classList.contains("dark")?dark:light;
      return Array.from({length:n},(_,i)=>use[i%use.length]);
    }
    let chart;
    function renderChart(dataset){
      const ctx=document.getElementById("hotChart");
      const colors=getColors(dataset.series.length);
      const ds=dataset.series.map((s,i)=>({label:s.name,data:s.data,borderColor:colors[i],backgroundColor:"transparent",tension:.25,borderWidth:2,pointRadius:2}));
      chart&&chart.destroy();
      chart=new Chart(ctx,{type:"line",data:{labels:dataset.labels,datasets:ds},
        options:{responsive:true,maintainAspectRatio:false,
          scales:{x:{grid:{display:false},ticks:{color:getComputedStyle(document.documentElement).getPropertyValue('--subtext')}},
                  y:{grid:{color:getComputedStyle(document.documentElement).getPropertyValue('--border')},ticks:{color:getComputedStyle(document.documentElement).getPropertyValue('--subtext')}}},
          plugins:{legend:{labels:{color:getComputedStyle(document.documentElement).getPropertyValue('--text')}},tooltip:{mode:"index",intersect:false}}}});
    }
    const obs=new MutationObserver(()=>{if(chart)chart.update();});
    obs.observe(document.documentElement,{attributes:true,attributeFilter:["class"]});

    loadLatestReport();
    loadTrendsAndKeywords();
    loadMetrics();
  </script>
</body>
</html>
