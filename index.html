<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æŠ•èµ„çƒ­ç‚¹ | TrendRadar</title>
  <link rel="icon" href="./img/trend-icon.png" />
  <meta name="description" content="TrendRadar æŠ•èµ„çƒ­ç‚¹è‡ªåŠ¨è¿½è¸ªç³»ç»Ÿ" />

  <style>
    :root{
      --bg: #f5f7fa;
      --card: #ffffff;
      --text: #1f2d3d;
      --subtext:#6b7280;
      --brand:#2563eb;
      --muted:#eef2f7;
      --shadow: 0 2px 12px rgba(0,0,0,.06);
      --header:#0f172a; --headerText:#fff;
      --chip:#f1f5f9; --chipHover:#e2e8f0; --chipText:#1f2937;
      --border:#e5e7eb;
    }
    .dark{
      --bg:#0b1018;
      --card:#0f1622;
      --text:#e5e7eb;
      --subtext:#9aa4b2;
      --brand:#4f8cff;
      --muted:#0b121c;
      --shadow: 0 2px 14px rgba(0,0,0,.35);
      --header:#070b12; --headerText:#e5e7eb;
      --chip:#101827; --chipHover:#122036; --chipText:#cbd5e1;
      --border:#213044;
    }

    *{box-sizing:border-box}
    body{
      font-family: "Inter","PingFang SC","Microsoft Yahei",sans-serif;
      margin:0; background:var(--bg); color:var(--text);
    }

    .header{
      background:var(--header); color:var(--headerText);
      padding:12px 20px; display:flex; align-items:center; justify-content:space-between;
      position:sticky; top:0; z-index:10; box-shadow:var(--shadow);
    }
    .header-left{display:flex; align-items:center; gap:10px; font-weight:700;}
    .logo{width:28px; height:28px}
    .update-time{font-size:.9rem; color:var(--subtext)}
    .actions{display:flex; align-items:center; gap:10px}
    .btn{
      border:1px solid var(--border); background:transparent; color:var(--headerText);
      padding:6px 10px; border-radius:8px; cursor:pointer; font-size:.9rem;
    }
    .btn:hover{background:rgba(255,255,255,.06)}
    .btn:active{transform:translateY(1px)}

    .container{
      max-width:1100px; margin:32px auto; padding:0 18px;
      display:grid; grid-template-columns:2fr 1fr; gap:22px;
    }
    .card{
      background:var(--card); border-radius:12px; box-shadow:var(--shadow); padding:22px;
      border:1px solid var(--border);
    }
    h2{
      margin:0 0 16px; font-size:1.1rem; color:var(--brand);
      border-left:4px solid var(--brand); padding-left:10px;
    }

    .keywords{display:flex; flex-wrap:wrap; gap:8px}
    .keywords span{
      background:var(--chip); color:var(--chipText); padding:6px 12px; border-radius:999px;
      border:1px solid var(--border); cursor:pointer; transition:.15s;
      user-select:none; font-size:.9rem;
    }
    .keywords span:hover{background:var(--chipHover)}

    .chart-wrap{height:280px}

    .footer{ text-align:center; color:var(--subtext); padding:24px 10px; font-size:.88rem }

    @media (max-width:860px){
      .container{grid-template-columns:1fr; gap:18px}
      .chart-wrap{height:240px}
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <img src="./img/trend-icon.png" class="logo" alt="logo"/>
      <div>æŠ•èµ„çƒ­ç‚¹ | TrendRadar</div>
    </div>
    <div class="actions">
      <div class="update-time" id="update-time">åŠ è½½ä¸­...</div>
      <button class="btn" id="theme-toggle" aria-label="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™ æš—é»‘</button>
    </div>
  </header>

  <main class="container">
    <!-- ä½¿ç”¨ iframe æ˜¾ç¤ºæ—¥æŠ¥ï¼Œé˜²æ­¢æ ·å¼å†²çª -->
    <section class="card" id="trend-content">
      <h2>ğŸ“ˆ ä»Šæ—¥é‡ç‚¹è¶‹åŠ¿</h2>
      <iframe id="report-frame"
              title="å½“æ—¥çƒ­ç‚¹"
              style="width:100%;border:0;border-radius:8px; background:transparent; min-height: 1200px;"
              loading="lazy"></iframe>
      <div class="source" id="report-note">æ­£åœ¨åŠ è½½æ—¥æŠ¥â€¦</div>
    </section>

    <section class="card">
      <h2>ğŸ”¥ çƒ­æœå…³é”®è¯</h2>
      <div class="keywords" id="kw">
        <span>äººå·¥æ™ºèƒ½</span><span>å°ç§¯ç”µ</span><span>ç¢³ä¸­å’Œ</span>
        <span>ChatGPT</span><span>å…‰ä¼</span><span>æ–°èƒ½æº</span><span>è‹¹æœ</span>
      </div>
    </section>

    <section class="card">
      <h2>ğŸ“Š çƒ­è¯çƒ­åº¦è¶‹åŠ¿</h2>
      <div class="chart-wrap"><canvas id="hotChart"></canvas></div>
      <div class="source" id="chart-note">æ•°æ®åŠ è½½ä¸­â€¦</div>
    </section>
  </main>

  <footer class="footer">
    Â© 2025 TrendRadar | æ•°æ®æ¥æºï¼šåå°”è¡—è§é—» Â· æ–°æµªè´¢ç» Â· ç™¾åº¦æŒ‡æ•°
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <script>
    // æ›´æ–°æ—¶é—´
    const upEl = document.getElementById("update-time");
    upEl.textContent = "æ›´æ–°äº " + new Date().toLocaleString("zh-CN", {hour12:false});

    // ä¸»é¢˜åˆ‡æ¢
    const keyTheme = "tr-theme";
    const toggleBtn = document.getElementById("theme-toggle");
    const applyTheme = (t) => {
      if(t==="dark"){ document.documentElement.classList.add("dark"); toggleBtn.textContent="â˜€ï¸ äº®è‰²"; }
      else { document.documentElement.classList.remove("dark"); toggleBtn.textContent="ğŸŒ™ æš—é»‘"; }
    };
    (()=>{ 
      const saved = localStorage.getItem(keyTheme);
      if(saved){ applyTheme(saved); }
      else{
        const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
        applyTheme(prefersDark?"dark":"light");
      }
    })();
    toggleBtn.onclick = () => {
      const nowDark = document.documentElement.classList.contains("dark");
      const next = nowDark ? "light":"dark";
      applyTheme(next); localStorage.setItem(keyTheme,next);
      if(chart){ chart.update(); }
    };

    // è·å–CSSå˜é‡
    const getCss = (v) => getComputedStyle(document.documentElement).getPropertyValue(v).trim();
    const cacheBust = () => `?v=${Date.now()}`;

    // åŠ è½½æ—¥æŠ¥ iframe
    async function loadLatestReport(){
      const note = document.getElementById("report-note");
      const frame = document.getElementById("report-frame");
      try{
        const resp = await fetch("./output/");
        const html = await resp.text();
        const m = [...html.matchAll(/href="(\d{8,}|20\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥)\/"/g)];
        if(!m.length){ note.textContent = "æœªæ‰¾åˆ°æ—¥æŠ¥ç›®å½•"; return; }
        const latest = m[m.length-1][1];
        const src = `./output/${latest}/html/å½“æ—¥çƒ­ç‚¹.html${cacheBust()}`;
        frame.src = src;
        note.textContent = `æ•°æ®æºï¼š${src}`;
        frame.onload = () => {
          try{
            const h = frame.contentDocument?.body?.scrollHeight || 0;
            if(h > 0) frame.style.minHeight = Math.min(h + 20, 4000) + "px";
          }catch(_){} 
        };
      }catch(e){
        note.textContent = "åŠ è½½æ—¥æŠ¥å¤±è´¥";
      }
    }
    loadLatestReport();

    // åŠ è½½ metrics.json
    async function loadMetrics(){
      const note = document.getElementById("chart-note");
      let data;
      try{
        const r = await fetch(`/TrendRadar/api/metrics.json${cacheBust()}`);
        if(r.ok){ data = await r.json(); note.textContent = "æ•°æ®æºï¼š/api/metrics.json"; }
      }catch(e){}

      if(!data){
        data = {
          labels:["09:30","10:00","10:30","11:00","13:00","14:00","14:30","15:00"],
          series:[
            {name:"äººå·¥æ™ºèƒ½", data:[12,18,25,27,30,28,35,40]},
            {name:"å…‰ä¼", data:[8,12,14,18,20,22,21,24]},
            {name:"å°ç§¯ç”µ", data:[10,11,13,15,16,18,19,22]}
          ]
        };
        note.textContent = "æ•°æ®æºï¼šç¤ºä¾‹ï¼ˆæœªæ£€æµ‹åˆ° /api/metrics.jsonï¼‰";
      }
      renderChart(data);
    }

    // ç»˜å›¾
    let chart;
    function renderChart(dataset){
      const ctx = document.getElementById("hotChart");
      const colors = ["#4f8cff","#22c55e","#f59e0b","#ef4444","#a78bfa"];
      const ds = dataset.series.map((s,i)=>({
        label:s.name, data:s.data, borderColor:colors[i%colors.length],
        backgroundColor:"transparent", tension:.25, borderWidth:2, pointRadius:2
      }));
      chart && chart.destroy();
      chart = new Chart(ctx,{
        type:"line",
        data:{ labels:dataset.labels, datasets:ds },
        options:{
          responsive:true, maintainAspectRatio:false,
          scales:{
            x:{ ticks:{ color:getCss('--subtext') }, grid:{display:false} },
            y:{ ticks:{ color:getCss('--subtext') }, grid:{ color:getCss('--border') } }
          },
          plugins:{ legend:{ labels:{ color:getCss('--text') } } }
        }
      });
    }

    loadMetrics();
  </script>
</body>
</html>
